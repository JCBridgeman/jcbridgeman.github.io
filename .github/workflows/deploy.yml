name: deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup variables
      id: setup
      run: |
        echo "SRC_BRANCH=master" >> $GITHUB_OUTPUT
        echo "DEPLOY_BRANCH=gh-pages" >> $GITHUB_OUTPUT
        echo "NO_PUSH=" >> $GITHUB_OUTPUT

    - name: Build site
      run: |
        docker run \
          -v ${{ github.workspace }}:/srv/jekyll \
          jekyll/jekyll:latest bash -lc "
            apt-get update &&
            apt-get install -y imagemagick &&
            jekyll build --future
          "

        # copy built site back into workspace (Docker stores it inside /srv/jekyll/_site)
        cp -r ${{ github.workspace }}/_site ${{ github.workspace }}/_site

    - name: Deploy website
      run: |
        yes | bash bin/deploy --verbose \
          ${{ steps.setup.outputs.NO_PUSH }} \
          --src ${{ steps.setup.outputs.SRC_BRANCH }} \
          --deploy ${{ steps.setup.outputs.DEPLOY_BRANCH }}
